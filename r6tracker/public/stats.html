<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Stats - R6 Tracker</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        .stats-controls {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            margin-bottom: 2rem;
        }

        #playerSelect {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23F1F5F9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1rem;
            padding-right: 2.5rem !important;
            background-color: var(--dark);
            color: var(--light);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
        }

        .charts-container {
            margin-top: 2rem;
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .chart-wrapper {
            background: var(--dark-secondary);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .stats-card {
            background: var(--dark-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .stat-item {
            text-align: center;
            padding: 1.5rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2rem;
            color: var(--primary);
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .stat-label {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .stat-blurb {
            font-size: 0.75rem;
            color: var(--secondary);
            margin-top: 0.5rem;
            line-height: 1.3;
            min-height: 32px;
        }

        .match-count {
            font-size: 0.9rem;
            color: var(--secondary);
            font-weight: normal;
            margin-left: 0.5rem;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .stats-controls {
                grid-template-columns: 1fr;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="auth-container" id="loginSection">
        <h2>Team Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" class="form-input" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" class="form-input" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
    </div>

    <div class="container" id="statsContent" style="display: none;">
        <div class="nav-header">
            <h1>üìä Player Stats</h1>
            <div>
                <span id="teamName" class="team-name"></span>
                <button class="btn btn-secondary" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Back</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="stats-controls">
            <select id="playerSelect" class="form-input">
                <option value="">Select Player</option>
            </select>

            <div class="filter-buttons">
                <button class="btn btn-primary active" data-filter="overall">Overall</button>
                <button class="btn btn-primary" data-filter="map">By Map</button>
                <button class="btn btn-primary" data-filter="opponent">By Opponent</button>
            </div>

            <div id="mapFilterContainer" class="input-container hidden">
                <select id="mapFilter" class="form-input">
                    <option value="">All Maps</option>
                </select>
            </div>

            <div id="opponentFilterContainer" class="input-container hidden">
                <select id="opponentFilter" class="form-input">
                    <option value="">All Opponents</option>
                </select>
            </div>

            <div class="filter-input">
                <select id="scrimCount" class="form-input">
                    <option value="0" selected>All Scrims</option>
                    <option value="10">Last 10 Scrims</option>
                    <option value="20">Last 20 Scrims</option>
                    <option value="30">Last 30 Scrims</option>
                    <option value="50">Last 50 Scrims</option>
                </select>
            </div>

            <button class="btn btn-success" onclick="loadStats()">üîç Load Stats</button>
        </div>

        <div class="stats-results" id="statsResults"></div>
        <div class="charts-container">
            <div class="chart-wrapper">
                <canvas id="kdChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="survivalChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const firebaseConfig = {
                apiKey: "AIzaSyBRrm0ZrKfhrBWa7A0VghOz82ufJvHeJqI",
                authDomain: "r6stattracker.firebaseapp.com",
                databaseURL: "https://r6stattracker-default-rtdb.firebaseio.com",
                projectId: "r6stattracker",
                storageBucket: "r6stattracker.appspot.com",
                messagingSenderId: "575541861129",
                appId: "1:575541861129:web:28682f4fc01279e46651d8",
                measurementId: "G-TN7LJDJP3R"
            };

            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.database();
            
            let currentTeamId = null;
            let playerDisplayNames = {};
            let kdChart = null;
            let survivalChart = null;

            function calculateTrendLine(data) {
                const x = data.map((_, i) => i);
                const y = data;
                const n = x.length;
                
                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                for(let i = 0; i < n; i++) {
                    sumX += x[i];
                    sumY += y[i];
                    sumXY += x[i] * y[i];
                    sumXX += x[i] * x[i];
                }
                
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                
                return data.map((_, i) => slope * i + intercept);
            }

            function getStatDescription(statName, value) {
                const numValue = parseFloat(value);
                const descriptions = {
                    kd: [
                        { 
                            range: [0, 0.5], 
                            texts: [
                                "Focus on crosshair placement and pre-aiming common angles",
                                "Try playing support operators like Thermite or Thatcher",
                                "Work on drone preservation during prep phase",
                                "Practice quick peeking techniques in Aim Lab",
                                "Stay with at least one teammate for trade potential",
                                "Use lean mechanics more deliberately in gunfights",
                                "Focus on map knowledge for better positioning",
                                "Try using angled grips on weapons",
                                "Play more secure area to practice anchoring",
                                "Watch killcams to analyze positioning mistakes",
                                "Use vertical gameplay more effectively",
                                "Practice recoil control in training grounds",
                                "Communicate enemy positions more clearly",
                                "Experiment with different sensitivity settings",
                                "Focus on surviving to maintain defensive setups"
                            ]
                        },
                        { 
                            range: [0.5, 0.8], 
                            texts: [
                                "Improve peeking techniques with quick leans",
                                "Consider playing flex operators like Nomad",
                                "Practice site setup efficiency",
                                "Work on cross-map rotations between sites",
                                "Use bulletproof cameras for intel gathering",
                                "Experiment with different reticle colors",
                                "Practice quick scope transitions",
                                "Focus on headshot accuracy in T-Hunts",
                                "Use secondary shotguns for site remodeling",
                                "Coordinate better with hard breachers",
                                "Analyze pro player positioning on maps",
                                "Practice quick plant/defuse scenarios",
                                "Use sound cues more effectively",
                                "Work on quick gadget deployment",
                                "Practice 1vX clutch situations"
                            ]
                        },
                        { 
                            range: [0.8, 1.2], 
                            texts: [
                                "Maintain aggressive angle control",
                                "Try entry fragger roles with Ash or Zofia",
                                "Practice quick refrags after teammate deaths",
                                "Work on flank watch routines",
                                "Use stun grenades to clear corners",
                                "Practice quick rotate strategies",
                                "Focus on spawn peeking techniques",
                                "Work on vertical gameplay coordination",
                                "Practice quick operator swaps based on team needs",
                                "Analyze match replays for positioning errors",
                                "Coordinate better with soft breachers",
                                "Practice quick rappel entries",
                                "Use impact grenades for quick rotations",
                                "Work on post-plant positioning",
                                "Practice quick defuser disable techniques"
                            ]
                        },
                        { 
                            range: [1.2, Infinity], 
                            texts: [
                                "Consider IGL role with your game sense",
                                "Mentor newer players on team strategies",
                                "Practice advanced peek spots",
                                "Work on unpredictable flank routes",
                                "Coordinate complex strat executions",
                                "Practice quick role switching mid-round",
                                "Focus on pro league strats adaptation",
                                "Work on fake-out tactics",
                                "Practice advanced vertical play",
                                "Coordinate cross-fire setups",
                                "Master quick plant/deny techniques",
                                "Develop unique operator combinations",
                                "Practice advanced baiting techniques",
                                "Work on mind-game strategies",
                                "Coordinate multi-pronged attacks"
                            ]
                        }
                    ],
                    survival: [
                        { 
                            range: [0, 30], 
                            texts: [
                                "Work on rotation timing and map awareness",
                                "Try anchoring sites more frequently",
                                "Communicate enemy positions earlier",
                                "Use bulletproof gadgets for cover",
                                "Practice safe peek timing",
                                "Stay closer to site anchors",
                                "Use proximity alarms for flank watch",
                                "Focus on camera usage during downtime",
                                "Play operators with passive gadgets",
                                "Practice defensive crosshair placement",
                                "Use deployable shields for cover",
                                "Communicate teammate positions better",
                                "Work on late-round positioning",
                                "Practice quick rotate paths",
                                "Use sound masking techniques"
                            ]
                        },
                        { 
                            range: [30, 50], 
                            texts: [
                                "Improve situational awareness",
                                "Practice quick repositioning after engages",
                                "Use barbed wire to slow pushes",
                                "Coordinate better with roam clear",
                                "Work on intel sharing efficiency",
                                "Practice quick refrag positioning",
                                "Use rotation holes strategically",
                                "Focus on time management",
                                "Play operators with intel denial",
                                "Practice quick flank cuts",
                                "Use environmental destruction for sightlines",
                                "Work on baiting enemy utility",
                                "Practice fake rotates",
                                "Coordinate cross-map pincer moves",
                                "Use deception tactics more"
                            ]
                        },
                        { 
                            range: [50, 70], 
                            texts: [
                                "Maintain good position rotation",
                                "Practice advanced peek-and-retreat",
                                "Use bullet holes for sneaky angles",
                                "Work on late-round flank potential",
                                "Coordinate fake site setups",
                                "Practice quick plant denial",
                                "Use environmental sounds for misdirection",
                                "Focus on operator synergy",
                                "Work on adaptive strategies",
                                "Practice quick utility deployment",
                                "Use smoke grenades for cover",
                                "Coordinate timed pushes",
                                "Practice quick defuser checks",
                                "Work on stamina management",
                                "Use decoy tactics effectively"
                            ]
                        },
                        { 
                            range: [70, Infinity], 
                            texts: [
                                "Master advanced positioning",
                                "Coordinate complex fakes",
                                "Practice psychological warfare",
                                "Use advanced audio manipulation",
                                "Work on pro-level strats",
                                "Practice quick adapt mid-round",
                                "Coordinate multi-layer defenses",
                                "Use unpredictable rotate patterns",
                                "Master mind-game techniques",
                                "Practice advanced baiting",
                                "Coordinate cross-fire setups",
                                "Use environmental destruction creatively",
                                "Work on pro-level time management",
                                "Practice tournament-level comms",
                                "Develop signature strategies"
                            ]
                        }
                    ],
                    plusMinus: [
                        { 
                            range: [-Infinity, -5], 
                            texts: [
                                "Focus on support role utility usage",
                                "Play operators with non-gun utility",
                                "Improve communication for trade potential",
                                "Use cameras more effectively",
                                "Stay behind entry fraggers",
                                "Practice defensive positioning",
                                "Use bulletproof gadgets for team support",
                                "Focus on drone management",
                                "Play hard breachers more",
                                "Practice site setup speed",
                                "Use traps to slow enemy pushes",
                                "Work on crosshair placement",
                                "Communicate enemy positions faster",
                                "Practice quick rotate calls",
                                "Use denial operators effectively"
                            ]
                        },
                        { 
                            range: [-5, 0], 
                            texts: [
                                "Improve trade potential positioning",
                                "Practice quick refrag timing",
                                "Use stun grenades more effectively",
                                "Work on crossfire setups",
                                "Coordinate better with teammates",
                                "Practice quick rotate decisions",
                                "Use intel operators more",
                                "Focus on post-plant strategies",
                                "Play flex operators",
                                "Practice quick flank watch",
                                "Use secondary gadgets aggressively",
                                "Work on time management",
                                "Communicate utility usage better",
                                "Practice quick site remodeling",
                                "Use vertical play more"
                            ]
                        },
                        { 
                            range: [0, 5], 
                            texts: [
                                "Maintain current performance",
                                "Focus on consistent aim",
                                "Practice advanced peeking",
                                "Work on quick decision making",
                                "Coordinate strats execution",
                                "Practice advanced recoil control",
                                "Use operator gadgets aggressively",
                                "Focus on map control",
                                "Play entry fragger roles",
                                "Practice quick spawn peeks",
                                "Use vertical destruction creatively",
                                "Work on adaptive strategies",
                                "Communicate enemy patterns",
                                "Practice advanced movement",
                                "Use mind games effectively"
                            ]
                        },
                        { 
                            range: [5, Infinity], 
                            texts: [
                                "Carry momentum into next matches",
                                "Mentor teammates on strategies",
                                "Practice advanced techniques",
                                "Coordinate complex strats",
                                "Analyze pro player demos",
                                "Develop signature playstyle",
                                "Practice tournament-level play",
                                "Work on clutch potential",
                                "Use unpredictable tactics",
                                "Coordinate multi-phase attacks",
                                "Master advanced utility usage",
                                "Practice IGL techniques",
                                "Develop meta strategies",
                                "Work on psychological pressure",
                                "Practice championship-level play"
                            ]
                        }
                    ],
                    kpr: [
                        { 
                            range: [0, 0.4], 
                            texts: [
                                "Focus on utility usage over frags",
                                "Practice post-plant strategies",
                                "Work on flank watch effectiveness",
                                "Use support gadgets more",
                                "Play hard breach operators",
                                "Practice site setup speed",
                                "Use cameras for intel gathering",
                                "Focus on defensive positioning",
                                "Play trap operators",
                                "Practice quick rotate paths",
                                "Use denial gadgets effectively",
                                "Work on communication clarity",
                                "Practice baiting enemy utility",
                                "Use teamwork for frags",
                                "Focus on objective play"
                            ]
                        },
                        { 
                            range: [0.4, 0.7], 
                            texts: [
                                "Balance fragging and support",
                                "Practice quick peeks",
                                "Work on crosshair placement",
                                "Use flex operators",
                                "Coordinate with entry fraggers",
                                "Practice quick refrags",
                                "Use stuns for entry support",
                                "Focus on map control",
                                "Play intel operators",
                                "Practice quick rotates",
                                "Use vertical gameplay basics",
                                "Work on trade potential",
                                "Practice site execution",
                                "Use drones aggressively",
                                "Focus on mid-round decisions"
                            ]
                        },
                        { 
                            range: [0.7, 1.0], 
                            texts: [
                                "Aggressive playstyle maintenance",
                                "Practice advanced peeking",
                                "Work on spawn peek spots",
                                "Use entry fragger operators",
                                "Coordinate push timings",
                                "Practice quick flicks",
                                "Use destruction for angles",
                                "Focus on early picks",
                                "Play roam hunters",
                                "Practice advanced movement",
                                "Use vertical play aggressively",
                                "Work on unpredictability",
                                "Practice quick plant execution",
                                "Use fragger gadgets effectively",
                                "Focus on momentum building"
                            ]
                        },
                        { 
                            range: [1.0, Infinity], 
                            texts: [
                                "Dominate matches consistently",
                                "Practice pro-level techniques",
                                "Work on carry potential",
                                "Use advanced angle holds",
                                "Coordinate team frag potential",
                                "Practice tournament play",
                                "Use psychological pressure",
                                "Focus on highlight plays",
                                "Play clutch operators",
                                "Practice 1vX scenarios",
                                "Use mind-game tactics",
                                "Work on signature moves",
                                "Practice championship strats",
                                "Use advanced bait techniques",
                                "Focus on legacy building"
                            ]
                        }
                    ]
                };

                const category = descriptions[statName].find(c => numValue >= c.range[0]);
                return category ? category.texts[Math.floor(Math.random() * category.texts.length)] : "";
            }

            auth.onAuthStateChanged(async (user) => {
                const loginSection = document.getElementById('loginSection');
                const statsContent = document.getElementById('statsContent');
                
                if (!user) {
                    loginSection.style.display = 'block';
                    statsContent.style.display = 'none';
                    return;
                }

                try {
                    const teamSnapshot = await db.ref(`users/${user.uid}/teamId`).once('value');
                    currentTeamId = teamSnapshot.val();
                    if (!currentTeamId) throw new Error("No team association");

                    const teamNameSnapshot = await db.ref(`teams/${currentTeamId}/info/teamName`).once('value');
                    document.getElementById('teamName').textContent = teamNameSnapshot.val();

                    const playersSnap = await db.ref(`teams/${currentTeamId}/players`).once('value');
                    const playerSelect = document.getElementById('playerSelect');
                    playerSelect.innerHTML = '<option value="">Select Player</option>';
                    
                    playersSnap.forEach(player => {
                        const playerData = player.val();
                        playerDisplayNames[playerData.username] = playerData.displayName;
                        playerSelect.add(new Option(playerData.displayName, playerData.username));
                    });

                    const matchesSnap = await db.ref(`teams/${currentTeamId}/matches`).once('value');
                    const maps = new Set();
                    const opponents = new Set();

                    matchesSnap.forEach(match => {
                        const matchData = match.val();
                        opponents.add(matchData.opponent);
                        matchData.maps?.forEach(map => maps.add(map.mapName));
                    });

                    const mapSelect = document.getElementById('mapFilter');
                    maps.forEach(map => mapSelect.add(new Option(map, map)));

                    const opponentSelect = document.getElementById('opponentFilter');
                    opponents.forEach(opponent => opponentSelect.add(new Option(opponent, opponent)));

                    loginSection.style.display = 'none';
                    statsContent.style.display = 'block';
                } catch (error) {
                    console.error("Auth error:", error);
                    alert(error.message);
                    auth.signOut();
                }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    alert('Login failed: ' + error.message);
                }
            });

            window.loadStats = async () => {
                const playerUsername = document.getElementById('playerSelect').value;
                const displayName = playerDisplayNames[playerUsername];
                const mapFilter = document.getElementById('mapFilter').value;
                const opponentFilter = document.getElementById('opponentFilter').value;
                const scrimCount = parseInt(document.getElementById('scrimCount').value);

                if (!playerUsername) {
                    alert('Please select a player');
                    return;
                }

                try {
                    const matchesSnap = await db.ref(`teams/${currentTeamId}/matches`).once('value');
                    if (!matchesSnap.exists()) return;

                    let allMatches = [];
                    matchesSnap.forEach(match => {
                        allMatches.push({
                            key: match.key,
                            ...match.val(),
                            timestamp: match.val().timestamp || 0
                        });
                    });

                    const processedMatches = allMatches
                        .sort((a, b) => b.timestamp - a.timestamp)
                        .slice(0, scrimCount > 0 ? scrimCount : allMatches.length)
                        .reverse();

                    const statsData = {
                        labels: [],
                        kdData: [],
                        survivalData: [],
                        totalKills: 0,
                        totalDeaths: 0,
                        totalRounds: 0
                    };

                    processedMatches.forEach(match => {
                        if (document.querySelector('.filter-buttons .active').dataset.filter === 'opponent' && 
                           opponentFilter && match.opponent !== opponentFilter) return;

                        match.maps?.forEach(map => {
                            if (document.querySelector('.filter-buttons .active').dataset.filter === 'map' && 
                               mapFilter && map.mapName !== mapFilter) return;
                            
                            const playerStats = map.players?.[playerUsername];
                            if (!playerStats) return;

                            const rounds = map.teamScore + map.opponentScore;
                            
                            statsData.totalKills += playerStats.kills || 0;
                            statsData.totalDeaths += playerStats.deaths || 0;
                            statsData.totalRounds += rounds;

                            const survival = ((rounds - playerStats.deaths) / rounds * 100).toFixed(1);
                            const kd = (playerStats.kills / (playerStats.deaths || 1)).toFixed(2);
                            statsData.labels.push(`${map.mapName} vs ${match.opponent}`);
                            statsData.kdData.push(kd);
                            statsData.survivalData.push(survival);
                        });
                    });

                    updateStatsDisplay(displayName, statsData, processedMatches.length);
                    updateCharts(statsData);
                } catch (error) {
                    alert(error.message);
                }
            };

            function updateStatsDisplay(playerName, statsData, matchCount) {
                const avgKD = statsData.totalDeaths > 0 
                    ? (statsData.totalKills / statsData.totalDeaths).toFixed(2)
                    : statsData.totalKills.toFixed(2);
                    
                const avgSurvival = statsData.totalRounds > 0
                    ? ((statsData.totalRounds - statsData.totalDeaths) / statsData.totalRounds * 100).toFixed(1)
                    : '0.0';

                const plusMinus = statsData.totalKills - statsData.totalDeaths;
                const kpr = (statsData.totalKills / Math.max(statsData.totalRounds, 1)).toFixed(2);

                document.getElementById('statsResults').innerHTML = `
                    <div class="stats-card">
                        <h2>${playerName}'s Stats <span class="match-count">(${matchCount} matches analyzed)</span></h2>
                        <div class="stats-grid">
                            ${generateStatItem('kd', 'K/D Ratio', avgKD)}
                            ${generateStatItem('survival', 'Survival Rate', avgSurvival + '%')}
                            ${generateStatItem('plusMinus', '+/-', plusMinus)}
                            ${generateStatItem('kpr', 'Kills/Round', kpr)}
                        </div>
                    </div>
                `;
            }

            function generateStatItem(statType, label, value) {
                const blurb = statType ? getStatDescription(statType, value) : '';
                return `
                    <div class="stat-item">
                        <div class="stat-label">${label}</div>
                        <div class="stat-value">${value}</div>
                        ${blurb ? `<div class="stat-blurb">${blurb}</div>` : ''}
                    </div>
                `;
            }

            function updateCharts(statsData) {
                const kdTrend = calculateTrendLine(statsData.kdData.map(Number));
                const survivalTrend = calculateTrendLine(statsData.survivalData.map(Number));

                if(kdChart) kdChart.destroy();
                if(survivalChart) survivalChart.destroy();

                // KD Chart
                kdChart = new Chart(document.getElementById('kdChart'), {
                    type: 'line',
                    data: {
                        labels: statsData.labels,
                        datasets: [
                            {
                                label: 'K/D Ratio',
                                data: statsData.kdData,
                                borderColor: '#7C3AED',
                                backgroundColor: 'rgba(124, 58, 237, 0.1)',
                                tension: 0.1,
                                fill: true
                            },
                            {
                                label: 'Performance Trend',
                                data: kdTrend,
                                borderColor: 'rgba(255, 255, 255, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: '#F1F5F9' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#94A3B8' },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#94A3B8' },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            }
                        }
                    }
                });

                // Survival Chart
                survivalChart = new Chart(document.getElementById('survivalChart'), {
                    type: 'line',
                    data: {
                        labels: statsData.labels,
                        datasets: [
                            {
                                label: 'Survival Rate (%)',
                                data: statsData.survivalData,
                                borderColor: '#10B981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.1,
                                fill: true
                            },
                            {
                                label: 'Performance Trend',
                                data: survivalTrend,
                                borderColor: 'rgba(255, 165, 0, 0.5)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                pointRadius: 0,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: { color: '#F1F5F9' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#94A3B8' },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: { color: '#94A3B8' },
                                grid: { color: 'rgba(255,255,255,0.05)' }
                            }
                        }
                    }
                });
            }

            window.logout = () => {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            };

            document.querySelectorAll('.filter-buttons button').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.filter-buttons button').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    const filterType = this.dataset.filter;
                    document.getElementById('mapFilterContainer').classList.toggle('hidden', filterType !== 'map');
                    document.getElementById('opponentFilterContainer').classList.toggle('hidden', filterType !== 'opponent');
                });
            });
        })();
    </script>
</body>
</html>
