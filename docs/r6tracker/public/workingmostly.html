<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R6 Replay Upload</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="../public/wasm_exec.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f1f1f1;
      padding: 30px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 20px;
    }

    input[type="file"] {
      background-color: #1e1e1e;
      border: 1px solid #444;
      padding: 10px;
      color: white;
      border-radius: 6px;
      margin-right: 10px;
    }

    button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #218838;
    }

    .error {
      color: #ff6b6b;
      background-color: #2a0000;
      padding: 10px;
      border-left: 4px solid red;
      margin-bottom: 10px;
    }

    .match-status {
      background-color: #1f1f1f;
      border-left: 4px solid #4caf50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <h1>üéÆ Upload R6 Replay Files</h1>
  <input type="file" id="replayInput" multiple />
  <button onclick="startUpload()">Start Upload</button>
  <div id="status"></div>

  <script>
    // Firebase setup
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let wasmReady = false;

    function showError(msg) {
      const status = document.getElementById("status");
      const div = document.createElement("div");
      div.className = "error";
      div.innerText = msg;
      status.appendChild(div);
    }

    function log(msg) {
      const status = document.getElementById("status");
      const div = document.createElement("div");
      div.className = "match-status";
      div.innerText = msg;
      status.appendChild(div);
    }

    function initializeWASM() {
      const go = new Go();
      WebAssembly.instantiateStreaming(fetch("../public/r6-dissect.wasm"), go.importObject)
        .then(result => go.run(result.instance))
        .then(() => {
          if (typeof window.dissectReplay === "function") {
            wasmReady = true;
            console.log("‚úÖ WASM module loaded: dissectReplay is ready");
          } else {
            console.error("‚ùå WASM loaded but dissectReplay not registered");
            showError("Analysis engine failed to initialize. Try refreshing.");
          }
        })
        .catch(async error => {
          console.error("WASM initialization failed:", error);
          showError("Failed to load analysis engine. Retrying...");
          await new Promise(resolve => setTimeout(resolve, 1000));
          initializeWASM();
        });
    }

    async function startUpload() {
      const input = document.getElementById("replayInput");
      const files = input.files;

      if (!wasmReady) {
        showError("WASM not yet ready. Please wait a moment and try again.");
        return;
      }

      if (files.length === 0) {
        showError("Please select at least one .rec file.");
        return;
      }

      log("üöÄ Starting upload process...\n");

      let validFiles = 0;

      for (const file of files) {
        const name = file.name;
        log(`Processing ${name}...`);

        try {
          const arrayBuffer = await file.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);

          if (typeof window.dissectReplay !== "function") {
            throw new Error("WASM function dissectReplay not yet loaded");
          }

          const result = await Promise.race([
            window.dissectReplay(uint8Array),
            new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 10000))
          ]);

          const data = JSON.parse(result);
          if (data.error) {
            log(`‚ùå Error in ${name}: ${data.error}`);
          } else {
            log(`‚úÖ Parsed ${name}: ${data.matchID || "Match data loaded."}`);
            validFiles++;

            const matchID = data.matchID || name.replace(/\.rec$/i, "");
            await db.ref(`/pro_matches/${matchID}`).set(data);
            log(`‚òÅÔ∏è Uploaded to Firebase as /pro_matches/${matchID}`);
          }
        } catch (err) {
          log(`‚ùå Error in ${name}: ${err.message}`);
        }
      }

      if (validFiles === 0) {
        showError("‚ùå Error: No valid replay files processed - check file formats");
      } else {
        log(`üéâ Upload completed. ${validFiles} file(s) processed successfully.`);
      }
    }

    window.addEventListener("load", initializeWASM);
  </script>
</body>
</html>
