<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>R6 Match Replay Uploader</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/browserfs"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #111; color: #eee; padding: 20px; }
        input, button { margin: 10px 0; }
        #mapContainer { margin-top: 20px; }
        .map-block { border: 1px solid #666; padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>Upload R6 Replay</h2>

    <label>Team ID: <input type="text" id="teamId" placeholder="e.g. soulz" /></label><br>
    <label>Opponent: <input type="text" id="opponent" placeholder="e.g. SHSU" /></label><br>

    <div id="mapContainer">
        <div class="map-block">
            <label>Replay Folder: <input type="file" class="replay-folder" webkitdirectory directory multiple /></label>
        </div>
    </div>

    <button onclick="addReplay()">Add Another Map</button>
    <button onclick="upload()">Upload to Firebase</button>

    <pre id="output" style="margin-top:20px; white-space:pre-wrap;"></pre>

    <script type="module">
        import init, { parse_replay } from "./r6-dissect.wasm";

        const firebaseConfig = {
            apiKey: "AIzaSyBRrm0ZrKfhrBWa7A0VghOz82ufJvHeJqI",
            authDomain: "r6stattracker.firebaseapp.com",
            databaseURL: "https://r6stattracker-default-rtdb.firebaseio.com",
            projectId: "r6stattracker",
            storageBucket: "r6stattracker.appspot.com",
            messagingSenderId: "575541861129",
            appId: "1:575541861129:web:28682f4fc01279e46651d8",
            measurementId: "G-TN7LJDJP3R"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        async function upload() {
            const teamId = document.getElementById('teamId').value.trim();
            const opponent = document.getElementById('opponent').value.trim();
            if (!teamId || !opponent) return alert("Please enter team ID and opponent.");

            await init(); // wait for WASM

            let allParsedMaps = {};
            const folderBlocks = document.querySelectorAll('.replay-folder');
            for (let i = 0; i < folderBlocks.length; i++) {
                const files = folderBlocks[i].files;
                if (!files.length) continue;

                const bfsData = {};
                for (let file of files) {
                    bfsData[file.webkitRelativePath] = new Uint8Array(await file.arrayBuffer());
                }

                await new Promise((resolve, reject) => {
                    BrowserFS.configure({ fs: "InMemory", options: {} }, function(err) {
                        if (err) return reject(err);
                        const fs = BrowserFS.BFSRequire("fs");
                        for (const path in bfsData) {
                            const dirs = path.split("/");
                            dirs.pop();
                            let dirPath = "";
                            for (const d of dirs) {
                                dirPath += "/" + d;
                                if (!fs.existsSync(dirPath)) fs.mkdirSync(dirPath);
                            }
                            fs.writeFileSync("/" + path, bfsData[path]);
                        }
                        resolve();
                    });
                });

                const mapResult = parse_replay();
                const folderName = files[0].webkitRelativePath.split("/")[0];
                allParsedMaps[`map_${i}`] = {
                    ...mapResult,
                    folderName
                };
            }

            const matchData = {
                teamId,
                opponent,
                date: new Date().toISOString(),
                maps: allParsedMaps,
                events: []
            };

            const matchId = `match_${opponent}_${new Date().toISOString().split("T")[0]}`;
            document.getElementById('output').textContent = JSON.stringify(matchData, null, 2);

            await db.ref("/matches/" + matchId).set(matchData);
            alert("Upload complete!");
        }

        function addReplay() {
            const div = document.createElement('div');
            div.className = "map-block";
            div.innerHTML = `
                <label>Replay Folder: <input type="file" class="replay-folder" webkitdirectory directory multiple /></label>
            `;
            document.getElementById('mapContainer').appendChild(div);
        }
    </script>
</body>
</html>
